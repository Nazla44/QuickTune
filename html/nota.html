<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nota Pembayaran - QuickTune</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background: #0f0c29; 
        }
        .invoice-box { 
            background: #1a1a2e; 
            border: 1px solid rgba(255, 73, 193, 0.3);
            border-radius: 30px; 
            overflow: hidden; 
        }
        .header-gradient {
            background: linear-gradient(135deg, #FF49C1 0%, #8000FF 100%);
        }
        .neon-text {
            color: #FF49C1;
            text-shadow: 0 0 10px rgba(255, 73, 193, 0.5);
        }
        @media print { 
            .no-print { display: none; } 
            body { background: white; color: black; } 
            .invoice-box { border: 1px solid #ccc; background: white; }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-6">

    <div class="w-full max-w-md">
        <div id="invoice-card" class="invoice-box shadow-[0_25px_50px_-12px_rgba(0,0,0,0.5)]">
            
            <div class="header-gradient p-8 text-center">
                <div class="inline-block p-4 bg-white/20 rounded-2xl mb-3">
                    <i class='bx bxs-microphone text-3xl text-white'></i>
                </div>
                <h1 class="text-3xl font-black tracking-widest text-white uppercase">QuickTune</h1>
                <p class="text-[10px] text-white/80 font-bold tracking-[0.3em] uppercase">Booking Confirmed</p>
            </div>

            <div class="p-8 space-y-6">
                <div class="space-y-1">
                    <p class="text-white text-lg">Halo, <strong id="display-name" class="neon-text">-</strong>!</p>
                    <p class="text-slate-400 text-xs leading-relaxed">Siapkan suaramu! Pembayaran untuk sesi karaoke kamu telah berhasil diverifikasi. Berikut adalah detail tiket digitalmu:</p>
                </div>

                <div class="bg-white/5 border border-white/10 rounded-2xl p-5 space-y-4">
                    <div class="border-b border-dashed border-white/10 pb-3">
                        <p class="text-[10px] text-pink-500 font-extrabold uppercase tracking-wider mb-1">Room Type</p>
                        <p id="note-room-info" class="text-white font-bold text-lg">-</p>
                    </div>

                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Date</p>
                            <p id="note-date" class="text-white font-semibold text-sm">--/--/----</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Transaction ID</p>
                            <p id="inv-no" class="text-white font-semibold text-sm">#QT-000000</p>
                        </div>
                    </div>
                </div>

                <div class="text-center py-4">
                    <p class="text-slate-400 text-xs mb-1 font-medium uppercase tracking-widest">Total Paid</p>
                    <h2 id="note-total" class="text-4xl font-black neon-text">Rp 0</h2>
                </div>

                <div class="text-center pt-2">
                    <p class="italic font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-500 text-lg">
                        Keep singing, keep shining!
                    </p>
                </div>
            </div>

            <div class="bg-black/20 p-6 text-center">
                <p class="text-[9px] text-slate-500 font-bold tracking-widest">&copy; 2025 QUICKTUNE KARAOKE. ALL RIGHTS RESERVED.</p>
            </div>
        </div>

        <p id="email-status" class="text-center text-[10px] mt-6 text-purple-400/60 font-medium tracking-wider uppercase">
            <i class='bx bx-loader-alt animate-spin'></i> Mengirim nota digital...
        </p>

        <div class="mt-8 grid grid-cols-2 gap-4 no-print">
            <button onclick="window.print()" class="bg-white/5 border border-white/10 text-white py-4 rounded-2xl font-bold text-xs hover:bg-white/10 transition-all uppercase tracking-widest">PRINT</button>
            <button onclick="localStorage.removeItem('currentBooking'); window.location.href='index.html'" class="header-gradient text-white py-4 rounded-2xl font-bold text-xs hover:opacity-90 transition-all uppercase tracking-widest">HOME</button>
        </div>
    </div>

<script>
    const data = JSON.parse(localStorage.getItem('currentBooking'));

    if(data) {
        const randomID = "QT-" + Math.floor(100000 + Math.random() * 900000);
        
        // Update tampilan layar
        document.getElementById('inv-no').innerText = "#" + randomID;
        document.getElementById('display-name').innerText = data.fullName;
        document.getElementById('note-room-info').innerText = data.room + " Room (" + data.duration + " Jam)";
        document.getElementById('note-date').innerText = data.date;
        document.getElementById('note-total').innerText = "Rp " + data.totalPrice.toLocaleString('id-ID');

        // --- KONFIGURASI SESUAI AKUN KAMU ---
        const SHEETDB_URL = "https://sheetdb.io/api/v1/kkvjvcqqeenzf"; 
        const PUBLIC_KEY = "qTyTiqybVsjz6O6Za";
        const SERVICE_ID = "QUICKTUNE";
        const TEMPLATE_ID = "template_y023ni7";

        emailjs.init(PUBLIC_KEY);

        // 1. KIRIM DATA KE GOOGLE SHEETS DULU
        fetch(SHEETDB_URL, {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                data: [
                    {
                        "orderID": randomID,
                        "name": data.fullName,
                        "email": data.email,
                        "room": data.room,
                        "duration": data.duration,
                        "date": data.date,
                        "total": data.totalPrice
                    }
                ]
            })
        })
        .then(res => res.json())
        .then(result => {
            console.log("SheetDB Success:", result);
            
            // 2. SETELAH BERHASIL SIMPAN, BARU KIRIM EMAIL
            const params = {
                to_email: data.email,
                to_name: data.fullName,
                order_id: randomID,
                room_type: data.room,
                total_price: "Rp " + data.totalPrice.toLocaleString('id-ID'),
                date: data.date
            };

            return emailjs.send(SERVICE_ID, TEMPLATE_ID, params);
        })
        .then(() => {
            document.getElementById('email-status').className = "text-center text-[10px] mt-6 text-green-400 font-bold uppercase tracking-widest";
            document.getElementById('email-status').innerHTML = "✅ DATA TERSIMPAN & NOTA TERKIRIM!";
        })
        .catch(err => {
            console.error("Error detail:", err);
            document.getElementById('email-status').className = "text-center text-[10px] mt-6 text-red-400 font-bold uppercase tracking-widest";
            document.getElementById('email-status').innerHTML = "❌ GAGAL: CEK KONEKSI / SETELAN SHEET";
        });

    } else {
        window.location.href = 'index.html';
    }
</script>
</body>
</html>
